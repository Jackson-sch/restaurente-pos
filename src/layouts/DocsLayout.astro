---
import "../styles/global.css";

interface Props {
  title?: string;
  description?: string;
  headings?: { depth: number; slug: string; text: string }[];
}

const {
  title = "Documentación - RestaurantePOS",
  description = "Documentación oficial del sistema RestaurantePOS.",
} = Astro.props;

// --- Data & Navigation Logic ---
const sidebarGroups = [
  {
    title: "Comenzando",
    items: [
      { label: "Introducción", href: "/docs" },
      { label: "Instalación", href: "/docs/instalacion" },
    ],
  },
  {
    title: "Guías",
    items: [
      { label: "Configuración", href: "/docs/configuracion" },
      { label: "Módulos del Sistema", href: "/docs/modulos" },
    ],
  },
  {
    title: "Enlaces",
    items: [
      { label: "Volver al Inicio", href: "/" },
      { label: "Soporte", href: "https://wa.me/57934835062", external: true },
    ],
  },
];

const currentPath = Astro.url.pathname;
const normalizePath = (path: string) => path.replace(/\/$/, "") || "/";
const normalizedCurrentPath = normalizePath(currentPath);

// Flatten items for Next/Prev logic
const flatItems = sidebarGroups.flatMap((group) => group.items);
const currentIndex = flatItems.findIndex(
  (item) => normalizePath(item.href) === normalizedCurrentPath,
);

const prevItem = currentIndex > 0 ? flatItems[currentIndex - 1] : null;
const nextItem =
  currentIndex < flatItems.length - 1 ? flatItems[currentIndex + 1] : null;
---

<!doctype html>
<html lang="es" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <title>{title}</title>
  </head>
  <body
    class="bg-[#0B1120] text-slate-300 antialiased min-h-screen selection:bg-primary-500/30 selection:text-white"
  >
    <!-- Background Decor (Glow) -->
    <div
      class="fixed top-0 left-1/2 -translate-x-1/2 w-[1000px] h-[400px] bg-primary-500/10 blur-[100px] rounded-full pointer-events-none z-0"
    >
    </div>
    <div
      class="fixed inset-0 z-0 opacity-20 pointer-events-none"
      style="background-image: radial-gradient(#334155 1px, transparent 1px); background-size: 32px 32px;"
    >
    </div>

    <!-- Mobile Header -->
    <header
      class="md:hidden sticky top-0 z-50 border-b border-white/5 bg-[#0B1120]/80 backdrop-blur-xl"
    >
      <div class="flex items-center justify-between p-4">
        <a href="/" class="flex items-center gap-2">
          <div
            class="w-6 h-6 rounded bg-gradient-to-br from-primary-500 to-primary-600 flex items-center justify-center"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-4 h-4 text-white"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              ><path d="M3 11v3a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1v-3"></path></svg
            >
          </div>
          <span class="font-bold text-white tracking-tight">Docs</span>
        </a>
        <button
          id="mobile-menu-toggle"
          class="p-2 text-slate-400 hover:text-white transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-6 h-6"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            ><line x1="3" x2="21" y1="6" y2="6"></line><line
              x1="3"
              x2="21"
              y1="12"
              y2="12"></line><line x1="3" x2="21" y1="18" y2="18"></line></svg
          >
        </button>
      </div>
    </header>

    <div class="flex max-w-[1440px] mx-auto relative z-10">
      <!-- Sidebar Desktop -->
      <aside
        class="hidden md:flex flex-col w-64 lg:w-72 fixed h-screen border-r border-white/5 bg-[#0B1120] pt-8 pb-10"
      >
        <!-- Logo -->
        <div class="px-6 mb-6">
          <a href="/" class="flex items-center gap-3 group">
            <div
              class="w-8 h-8 rounded-lg bg-gradient-to-br from-primary-500 to-primary-600 flex items-center justify-center shadow-lg shadow-primary-500/20 group-hover:shadow-primary-500/40 transition-all duration-300"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-5 h-5 text-white"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                ><path d="M3 11v3a1 1 0 0 0 1 1h16a1 1 0 0 0 1-1v-3"
                ></path><path
                  d="M12 19H4a1 1 0 0 1-1-1v-2a1 1 0 0 1 1-1h16a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-3.83"
                ></path></svg
              >
            </div>
            <span class="font-bold text-lg text-white tracking-tight"
              >Restaurante<span class="text-primary-500">POS</span></span
            >
          </a>
        </div>

        <!-- Search Bar -->
        <div class="px-6 mb-8">
          <button
            class="w-full flex items-center gap-2 bg-[#1e293b] hover:bg-[#1e293b]/80 border border-white/10 rounded-lg px-3 py-2 text-sm text-slate-400 focus:outline-none focus:ring-2 focus:ring-primary-500/50 transition-all text-left"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-4 h-4 opacity-50"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              ><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.3-4.3"
              ></path></svg
            >
            <span>Buscar...</span>
            <kbd
              class="ml-auto text-[10px] font-mono bg-white/5 px-1.5 py-0.5 rounded border border-white/10"
              >Ctrl K</kbd
            >
          </button>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 px-4 space-y-8 overflow-y-auto custom-scrollbar">
          {
            sidebarGroups.map((group) => (
              <div>
                <h3 class="px-2 mb-3 text-xs font-semibold text-slate-500 uppercase tracking-wider font-mono">
                  {group.title}
                </h3>
                <ul class="space-y-1">
                  {group.items.map((item) => {
                    const isActive =
                      normalizePath(item.href) === normalizedCurrentPath;
                    return (
                      <li>
                        <a
                          href={item.href}
                          target={item.external ? "_blank" : undefined}
                          class={`
                          group flex items-center gap-2 px-2 py-2 rounded-md text-sm font-medium transition-all duration-200
                          ${
                            isActive
                              ? "text-primary-400 bg-primary-500/10 translate-x-1"
                              : "text-slate-400 hover:text-white hover:bg-white/5 hover:translate-x-1"
                          }
                        `}
                        >
                          {isActive ? (
                            <div class="w-1.5 h-1.5 rounded-full bg-primary-500 shadow-[0_0_8px_currentColor]" />
                          ) : (
                            <div class="w-1.5 h-1.5 rounded-full bg-transparent border border-slate-700 group-hover:border-slate-500" />
                          )}
                          {item.label}
                          {item.external && (
                            <svg
                              xmlns="http://www.w3.org/2000/svg"
                              class="w-3 h-3 ml-auto opacity-50"
                              viewBox="0 0 24 24"
                              fill="none"
                              stroke="currentColor"
                              stroke-width="2"
                            >
                              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                              <polyline points="15 3 21 3 21 9" />
                              <line x1="10" x2="21" y1="14" y2="3" />
                            </svg>
                          )}
                        </a>
                      </li>
                    );
                  })}
                </ul>
              </div>
            ))
          }
        </nav>
      </aside>

      <!-- Main Content -->
      <main class="flex-1 md:pl-64 lg:pl-72 w-full min-h-screen">
        <div class="max-w-4xl mx-auto px-6 py-10 md:py-16 lg:px-10">
          <!-- Breadcrumb -->
          <div class="mb-8 flex items-center gap-2 text-sm text-slate-500">
            <a href="/docs" class="hover:text-primary-400 transition-colors"
              >Docs</a
            >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="w-3 h-3"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"><path d="m9 18 6-6-6-6"></path></svg
            >
            <span class="text-primary-400 font-medium"
              >{
                sidebarGroups.find((g) =>
                  g.items.some(
                    (i) => normalizePath(i.href) === normalizedCurrentPath,
                  ),
                )?.title
              }</span
            >
          </div>

          <!-- Content Prose -->
          <article
            class="prose prose-invert prose-slate max-w-none
            prose-headings:font-bold prose-headings:tracking-tight prose-headings:text-white
            prose-h1:text-4xl lg:prose-h1:text-5xl prose-h1:mb-8 prose-h1:font-extrabold prose-h1:text-white
            prose-h2:text-2xl lg:prose-h2:text-3xl prose-h2:mt-12 prose-h2:mb-6 prose-h2:pb-4 prose-h2:border-b prose-h2:border-white/10
            prose-h3:text-xl prose-h3:mt-8 prose-h3:mb-4 prose-h3:text-primary-100
            prose-p:text-slate-400 prose-p:leading-8 prose-p:text-lg prose-p:mb-6
            prose-a:text-primary-400 prose-a:no-underline prose-a:border-b prose-a:border-primary-500/30 hover:prose-a:border-primary-500 transition-all font-medium
            prose-strong:text-white prose-strong:font-bold
            prose-code:text-primary-300 prose-code:font-mono prose-code:bg-primary-500/10 prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded-md prose-code:before:content-none prose-code:after:content-none
            prose-pre:bg-[#0f172a] prose-pre:border prose-pre:border-white/10 prose-pre:rounded-xl prose-pre:shadow-2xl prose-pre:p-0
            prose-ul:my-6 prose-ul:list-disc prose-ul:pl-6 prose-ul:text-slate-400
            prose-li:my-2
            prose-img:rounded-xl prose-img:border prose-img:border-white/10 prose-img:shadow-2xl
            prose-table:border-collapse prose-table:border prose-table:border-white/10 prose-table:rounded-lg prose-table:overflow-hidden
            prose-th:bg-white/5 prose-th:p-4 prose-th:text-white prose-th:font-semibold prose-th:text-left
            prose-td:p-4 prose-td:border-t prose-td:border-white/5"
          >
            <slot />
          </article>

          <!-- Footer Navigation -->
          <div
            class="mt-20 pt-10 border-t border-white/5 grid grid-cols-2 gap-4"
          >
            {
              prevItem && !prevItem.external ? (
                <a
                  href={prevItem.href}
                  class="group flex flex-col items-start gap-1 p-4 rounded-xl border border-white/5 hover:border-primary-500/30 hover:bg-white/[0.02] transition-all"
                >
                  <span class="text-xs text-slate-500 uppercase tracking-wider font-semibold">
                    Anterior
                  </span>
                  <div class="flex items-center gap-2 text-slate-300 group-hover:text-primary-400 transition-colors">
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="w-4 h-4 transition-transform group-hover:-translate-x-1"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path d="m15 18-6-6 6-6" />
                    </svg>
                    {prevItem.label}
                  </div>
                </a>
              ) : (
                <div />
              )
            }

            {
              nextItem && !nextItem.external ? (
                <a
                  href={nextItem.href}
                  class="group flex flex-col items-end gap-1 p-4 rounded-xl border border-white/5 hover:border-primary-500/30 hover:bg-white/[0.02] transition-all text-right"
                >
                  <span class="text-xs text-slate-500 uppercase tracking-wider font-semibold">
                    Siguiente
                  </span>
                  <div class="flex items-center gap-2 text-slate-300 group-hover:text-primary-400 transition-colors">
                    {nextItem.label}
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      class="w-4 h-4 transition-transform group-hover:translate-x-1"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path d="m9 18 6-6-6-6" />
                    </svg>
                  </div>
                </a>
              ) : (
                <div />
              )
            }
          </div>
        </div>
      </main>

      <!-- Table of Contents (Right Sidebar) -->
      <div
        class="hidden xl:block w-64 fixed right-0 top-0 h-screen overflow-y-auto pt-24 pb-10 pr-8"
      >
        <div class="pl-4 border-l border-white/5 relative">
          <!-- Active Indicator Line (JS will move this) -->
          <div
            id="toc-indicator"
            class="absolute left-[-1px] top-0 w-[1px] h-6 bg-primary-500 transition-all duration-300 hidden"
          >
          </div>

          <h5
            class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-4"
          >
            En esta página
          </h5>
          <ul id="toc-list" class="space-y-3 text-sm">
            <!-- JS will populate this based on H2/H3 -->
            <li class="text-slate-500 text-xs italic">Cargando índice...</li>
          </ul>

          <div class="mt-8 pt-6 border-t border-white/5">
            <button
              onclick="window.scrollTo({top: 0, behavior: 'smooth'})"
              class="flex items-center gap-2 text-xs text-slate-500 hover:text-primary-400 transition-colors"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="w-3 h-3"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"><path d="m18 15-6-6-6 6"></path></svg
              >
              Volver arriba
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile Menu Overlay -->
    <div
      id="mobile-sidebar"
      class="fixed inset-0 z-50 bg-[#0B1120] transform translate-x-full transition-transform duration-300 md:hidden flex flex-col"
    >
      <!-- ... existing mobile menu code ... -->
      <div
        class="p-4 border-b border-white/10 flex items-center justify-between"
      >
        <span class="font-bold text-white">Menú</span>
        <button id="close-mobile-menu" class="p-2 text-slate-400">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="w-6 h-6"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            ><line x1="18" x2="6" y1="6" y2="18"></line><line
              x1="6"
              x2="18"
              y1="6"
              y2="18"></line></svg
          >
        </button>
      </div>
      <div class="p-4 overflow-y-auto flex-1">
        <nav class="space-y-6">
          {
            sidebarGroups.map((group) => (
              <div>
                <h3 class="mb-3 text-xs font-semibold text-slate-500 uppercase tracking-wider">
                  {group.title}
                </h3>
                <ul class="space-y-2">
                  {group.items.map((item) => (
                    <li>
                      <a
                        href={item.href}
                        class="block px-3 py-2 rounded-md bg-white/5 text-slate-200 border border-white/5"
                      >
                        {item.label}
                      </a>
                    </li>
                  ))}
                </ul>
              </div>
            ))
          }
        </nav>
      </div>
    </div>

    <!-- SCRIPTS: Copy Button & TOC -->
    <script is:inline>
      // 1. ADVANCED CODE BLOCK (Window Style)
      document.querySelectorAll("pre").forEach((pre) => {
        // Detect language
        const code = pre.querySelector("code");
        let lang = "Terminal";
        if (code && code.className.includes("language-")) {
          lang = code.className.split("language-")[1].toUpperCase();
        } else if (
          (code && code.textContent.trim().startsWith("$")) ||
          code.textContent.trim().startsWith("npm") ||
          code.textContent.trim().startsWith("git")
        ) {
          lang = "BASH";
        }

        // Wrapper (The Window)
        const wrapper = document.createElement("div");
        wrapper.className =
          "my-8 rounded-xl overflow-hidden border border-white/10 bg-[#0f172a] shadow-2xl relative group";

        // Window Header
        const header = document.createElement("div");
        header.className =
          "flex items-center justify-between px-4 py-3 bg-[#1e293b]/50 border-b border-white/5";

        // Left: Controls + Title
        const left = document.createElement("div");
        left.className = "flex items-center gap-4";

        // Window Controls (Mac Style)
        const controls = document.createElement("div");
        controls.className = "flex items-center gap-2";
        controls.innerHTML = `
          <div class="w-3 h-3 rounded-full bg-[#ff5f56] border border-[#e0443e]"></div>
          <div class="w-3 h-3 rounded-full bg-[#ffbd2e] border border-[#dea123]"></div>
          <div class="w-3 h-3 rounded-full bg-[#27c93f] border border-[#1aab29]"></div>
        `;

        // Title/Lang
        const titleContainer = document.createElement("div");
        titleContainer.className =
          "flex items-center gap-2 text-xs font-mono text-slate-400 uppercase tracking-wider select-none";

        let icon =
          '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="4 17 10 11 4 5"/><line x1="12" x2="20" y1="19" y2="19"/></svg>'; // Terminal default

        if (lang === "JS" || lang === "TS" || lang === "JSON") {
          icon =
            '<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M12 18v-6"/><path d="m9 15 3 3 3-3"/></svg>';
        }

        titleContainer.innerHTML = `${icon} <span>${lang}</span>`;

        left.appendChild(controls);
        left.appendChild(titleContainer);

        // Right: Copy Button
        const copyBtn = document.createElement("button");
        copyBtn.className =
          "flex items-center gap-2 px-2.5 py-1.5 rounded-md bg-white/5 hover:bg-white/10 text-xs text-slate-400 hover:text-white transition-all border border-transparent hover:border-white/10";
        copyBtn.innerHTML = `
          <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
          <span>Copiar</span>
        `;

        copyBtn.addEventListener("click", async () => {
          const text = code?.innerText || "";
          await navigator.clipboard.writeText(text);

          copyBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 text-green-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
            <span class="text-green-400">Copiado</span>
          `;
          copyBtn.classList.add("bg-green-500/10", "border-green-500/20");

          setTimeout(() => {
            copyBtn.innerHTML = `
              <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
              <span>Copiar</span>
            `;
            copyBtn.classList.remove("bg-green-500/10", "border-green-500/20");
          }, 2000);
        });

        header.appendChild(left);
        header.appendChild(copyBtn);

        // Insert Header & content
        pre.parentNode.insertBefore(wrapper, pre);
        wrapper.appendChild(header);
        wrapper.appendChild(pre);

        // Clean up original pre styling
        pre.className = "";
        pre.style.margin = "0";
        pre.style.borderRadius = "0";
        pre.style.backgroundColor = "transparent";
        pre.style.padding = "1.25rem 1rem";
        pre.style.overflowX = "auto"; // ensure scrolling if needed
      });

      // 2. DYNAMIC TABLE OF CONTENTS
      const article = document.querySelector("article");
      const tocList = document.getElementById("toc-list");

      if (article && tocList) {
        const headings = article.querySelectorAll("h2, h3");
        if (headings.length > 0) {
          tocList.innerHTML = ""; // Clear placeholder

          headings.forEach((heading, index) => {
            const id = heading.id || `heading-${index}`;
            heading.id = id;

            const li = document.createElement("li");
            const link = document.createElement("a");
            link.href = `#${id}`;
            link.textContent = heading.textContent;
            link.className = `block text-slate-400 hover:text-primary-400 transition-colors ${heading.tagName === "H3" ? "pl-4 text-xs" : ""}`;

            // Scroll Spy Logic
            link.addEventListener("click", (e) => {
              e.preventDefault();
              document
                .querySelector(`#${id}`)
                .scrollIntoView({ behavior: "smooth" });
            });

            li.appendChild(link);
            tocList.appendChild(li);
          });
        } else {
          tocList.innerHTML =
            '<li class="text-slate-600 text-xs">Sin secciones</li>';
        }
      }

      // 3. MOBILE MENU Logic
      const menuToggle = document.getElementById("mobile-menu-toggle");
      const mobileSidebar = document.getElementById("mobile-sidebar");
      const closeMenu = document.getElementById("close-mobile-menu");

      function toggleMenu() {
        mobileSidebar?.classList.toggle("translate-x-full");
      }

      menuToggle?.addEventListener("click", toggleMenu);
      closeMenu?.addEventListener("click", toggleMenu);
    </script>
  </body>
</html>
